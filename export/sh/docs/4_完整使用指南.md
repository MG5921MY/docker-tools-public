# Docker Export Compose 融合脚本使用指南

## 📌 文档信息

- **创建日期**：2025-11-06
- **脚本版本**：v2.0
- **文档版本**：v1.0
- **适用系统**：Linux、macOS、WSL
- **文档目的**：完整的 docker-export-compose.sh 使用指南

---

## 📋 目录

- [1. 脚本简介](#1-脚本简介)
- [2. 快速开始](#2-快速开始)
- [3. 基础用法](#3-基础用法)
- [4. 高级用法](#4-高级用法)
- [5. 实战示例](#5-实战示例)
- [6. 常见问题](#6-常见问题)
- [7. 最佳实践](#7-最佳实践)

---

## 1. 脚本简介

### 1.1 功能特性

```
✅ 单个容器导出
✅ 批量容器导出（从文件）
✅ 导出所有容器（--all）
✅ 导出运行中容器（--all-run）
✅ 导出已停止容器（--all-stop）
✅ 自动目录管理（冲突自动递增）
✅ 中英文帮助信息
✅ 模拟运行模式（--dry-run）
✅ 覆盖模式（--overwrite）
✅ 安静模式（--quiet）
✅ 完整的配置提取（端口、卷、环境变量等）
✅ 不影响原容器运行
```

### 1.2 输出结构

```
默认输出：
./容器名/docker-compose.yml

目录冲突时自动递增：
./容器名/docker-compose.yml    ← 已存在
./容器名_1/docker-compose.yml  ← 自动创建
./容器名_2/docker-compose.yml  ← 再次运行
./容器名_3/docker-compose.yml  ← 继续递增

指定输出目录：
/backup/容器名/docker-compose.yml
```

---

## 2. 快速开始

### 2.1 安装准备

```bash
# 进入脚本目录
cd "E:\MIJIAOGAME\MijiaoNotes\Markdown\本机分类\Markdown\综合杂项分类\ZeroTier网络配置"

# 赋予执行权限
chmod +x docker-export-compose.sh

# 验证脚本
./docker-export-compose.sh --version
```

### 2.2 第一个示例

```bash
# 假设您有一个名为 nginx-web 的容器
docker ps | grep nginx-web

# 导出为 Compose 配置
./docker-export-compose.sh nginx-web

# 查看生成的文件
cat nginx-web/docker-compose.yml

# 测试配置
cd nginx-web
docker compose config

# 如果验证通过，可以使用
docker compose up -d
```

---

## 3. 基础用法

### 3.1 导出单个容器

```bash
# 语法
./docker-export-compose.sh <容器名>

# 示例 1：导出到当前目录
./docker-export-compose.sh my-container

# 输出：
# [INFO] 转换容器：my-container → ./my-container/docker-compose.yml
# [SUCCESS] 导出成功：./my-container/docker-compose.yml

# 示例 2：导出到指定目录
./docker-export-compose.sh -o /backup my-container

# 输出：
# [INFO] 转换容器：my-container → /backup/my-container/docker-compose.yml
```

### 3.2 查看帮助

```bash
# 英文帮助
./docker-export-compose.sh --help

# 中文帮助
./docker-export-compose.sh --help-cn

# 查看版本
./docker-export-compose.sh --version
```

### 3.3 模拟运行

```bash
# 使用 --dry-run 查看将要执行的操作，不实际创建文件
./docker-export-compose.sh --dry-run my-container

# 输出：
# [INFO] 转换容器：my-container → ./my-container/docker-compose.yml
# [INFO] [DRY-RUN] 将创建：./my-container/docker-compose.yml

# 用于批量操作前的预览
./docker-export-compose.sh --all-run --dry-run
```

---

## 4. 高级用法

### 4.1 批量导出（从文件）

#### 创建容器列表文件

```bash
# 创建 containers.txt
cat > containers.txt <<'EOF'
# 我的容器列表
# 每行一个容器名

# Web 服务
nginx-web
apache-web2

# 数据库
mysql-db
postgres-db

# 缓存
redis-cache

# 其他
easytier-web
EOF
```

#### 批量导出

```bash
# 从文件批量导出
./docker-export-compose.sh --file containers.txt

# 输出到指定目录
./docker-export-compose.sh --file containers.txt -o /backup

# 安静模式批量导出
./docker-export-compose.sh --file containers.txt --quiet
```

### 4.2 导出所有容器

```bash
# 导出所有容器（包括已停止）
./docker-export-compose.sh --all

# 只导出运行中的容器
./docker-export-compose.sh --all-run

# 只导出已停止的容器
./docker-export-compose.sh --all-stop

# 组合使用
./docker-export-compose.sh --all-run -o /backup
```

### 4.3 覆盖模式

```bash
# 默认：目录存在时自动递增
./docker-export-compose.sh my-container
# 输出：./my-container/docker-compose.yml

./docker-export-compose.sh my-container
# 输出：./my-container_1/docker-compose.yml

# 使用覆盖模式
./docker-export-compose.sh --overwrite my-container
# 输出：./my-container/docker-compose.yml（覆盖已存在的）
```

---

## 5. 实战示例

### 5.1 示例 1：导出 EasyTier 容器

```bash
# 场景：您有一个运行中的 EasyTier 容器

# 步骤 1：查看容器
docker ps | grep easytier
# easytier-web   easytier/easytier:latest   Up 2 hours

# 步骤 2：导出配置
./docker-export-compose.sh easytier-web

# 步骤 3：查看生成的文件
ls -la easytier-web/
# drwxr-xr-x  2 user user 4096 Nov  6 10:30 .
# -rw-r--r--  1 user user 1234 Nov  6 10:30 docker-compose.yml

cat easytier-web/docker-compose.yml

# 步骤 4：验证配置
cd easytier-web
docker compose config

# 步骤 5：测试启动（不影响原容器）
docker compose up -d

# 步骤 6：查看状态
docker compose ps
docker ps -a | grep easytier
# 现在有两个 easytier 容器（原容器 + Compose 容器）

# 步骤 7：如果测试成功，可以移除原容器
docker compose down  # 先停止 Compose 容器
docker stop easytier-web  # 停止原容器
docker rm easytier-web    # 删除原容器

# 步骤 8：使用 Compose 正式启动
docker compose up -d
```

### 5.2 示例 2：批量迁移多个容器

```bash
# 场景：迁移多个服务到 Compose 管理

# 步骤 1：列出当前运行的容器
docker ps --format "{{.Names}}"

# 步骤 2：创建容器列表
cat > migrate-list.txt <<'EOF'
nginx-web
mysql-db
redis-cache
app-backend
app-frontend
EOF

# 步骤 3：批量导出到备份目录
./docker-export-compose.sh --file migrate-list.txt -o /backup

# 步骤 4：检查导出结果
ls -la /backup/
# nginx-web/docker-compose.yml
# mysql-db/docker-compose.yml
# redis-cache/docker-compose.yml
# app-backend/docker-compose.yml
# app-frontend/docker-compose.yml

# 步骤 5：逐个验证和迁移
cd /backup/nginx-web
docker compose config  # 验证配置
docker compose up -d   # 测试启动
docker compose ps      # 查看状态

# 步骤 6：如果一切正常，停止原容器
docker stop nginx-web
docker rm nginx-web

# 步骤 7：重复步骤 5-6 迁移其他容器
```

### 5.3 示例 3：导出所有运行中的容器

```bash
# 场景：备份所有运行中容器的配置

# 步骤 1：导出所有运行中的容器
./docker-export-compose.sh --all-run -o /backup/docker-configs

# 输出：
# [INFO] 导出所有运行中的容器
# [INFO] 找到 5 个容器
# 
# 容器列表：
#   - nginx-web (nginx:latest) [running]
#   - mysql-db (mysql:8.0) [running]
#   - redis-cache (redis:alpine) [running]
#   - easytier-web (easytier/easytier:latest) [running]
#   - portainer (portainer/portainer-ce:latest) [running]
# 
# [INFO] 转换容器：nginx-web → /backup/docker-configs/nginx-web/docker-compose.yml
# [SUCCESS] 导出成功：/backup/docker-configs/nginx-web/docker-compose.yml
# ...

# 步骤 2：查看导出结果
tree /backup/docker-configs/
# /backup/docker-configs/
# ├── nginx-web/
# │   └── docker-compose.yml
# ├── mysql-db/
# │   └── docker-compose.yml
# ├── redis-cache/
# │   └── docker-compose.yml
# ├── easytier-web/
# │   └── docker-compose.yml
# └── portainer/
#     └── docker-compose.yml

# 步骤 3：打包备份
cd /backup
tar -czf docker-configs-$(date +%Y%m%d).tar.gz docker-configs/

# 步骤 4：验证备份
tar -tzf docker-configs-$(date +%Y%m%d).tar.gz
```

### 5.4 示例 4：处理目录冲突

```bash
# 场景：多次导出同一容器，观察自动递增

# 第一次导出
./docker-export-compose.sh my-container
# 输出：./my-container/docker-compose.yml

# 第二次导出（不覆盖）
./docker-export-compose.sh my-container
# 输出：./my-container_1/docker-compose.yml

# 第三次导出
./docker-export-compose.sh my-container
# 输出：./my-container_2/docker-compose.yml

# 使用覆盖模式
./docker-export-compose.sh --overwrite my-container
# 输出：./my-container/docker-compose.yml（覆盖原文件）

# 查看目录结构
ls -d my-container*
# my-container/
# my-container_1/
# my-container_2/
```

---

## 6. 常见问题

### 6.1 权限问题

**Q: Permission denied**

```bash
# 问题
-bash: ./docker-export-compose.sh: Permission denied

# 解决
chmod +x docker-export-compose.sh
```

**Q: Docker daemon 权限错误**

```bash
# 问题
Got permission denied while trying to connect to the Docker daemon

# 解决
sudo usermod -aG docker $USER
newgrp docker
```

### 6.2 容器相关问题

**Q: 容器不存在**

```bash
# 问题
[ERROR] 容器 'xxx' 不存在

# 解决
# 查看所有容器
docker ps -a

# 使用正确的容器名
./docker-export-compose.sh <正确的容器名>
```

**Q: 没有找到符合条件的容器**

```bash
# 问题
[WARN] 没有找到符合条件的容器

# 原因
# --all-run 但没有运行中的容器
# --all-stop 但没有已停止的容器

# 解决
# 检查容器状态
docker ps -a
```

### 6.3 输出相关问题

**Q: 生成的配置无法启动**

```bash
# 验证配置
cd <容器名>
docker compose config

# 查看错误信息
docker compose up

# 常见问题及修复：
# 1. 端口冲突 → 修改 ports 配置
# 2. 数据卷路径不存在 → 创建目录
# 3. 环境变量缺失 → 添加必要变量
```

**Q: 目录权限问题**

```bash
# 问题
mkdir: cannot create directory 'xxx': Permission denied

# 解决
# 检查输出目录权限
ls -la $OUTPUT_DIR

# 使用有权限的目录
./docker-export-compose.sh -o ~/backup my-container
```

---

## 7. 最佳实践

### 7.1 迁移前准备

```bash
# 1. 备份数据（重要！）
docker exec my-container tar -czf /backup.tar.gz /data

# 2. 记录容器状态
docker ps -a > containers-before.txt
docker images > images-before.txt

# 3. 导出配置
./docker-export-compose.sh --all -o /backup/compose-configs

# 4. 验证所有配置
for dir in /backup/compose-configs/*/; do
    cd "$dir"
    echo "验证: $dir"
    docker compose config || echo "配置错误: $dir"
done
```

### 7.2 逐个迁移策略

```bash
# 不要一次性迁移所有容器！
# 推荐逐个迁移，降低风险

# 步骤 1：从最不重要的容器开始
./docker-export-compose.sh test-container

# 步骤 2：验证
cd test-container
docker compose config
docker compose up -d

# 步骤 3：测试一段时间（如 1 小时）
# 确认没有问题

# 步骤 4：停止原容器
docker stop test-container
docker rm test-container

# 步骤 5：继续下一个容器
# 重复步骤 1-4
```

### 7.3 版本管理

```bash
# 为每个导出的配置创建 Git 仓库

# 导出容器
./docker-export-compose.sh my-app -o ~/projects

# 初始化 Git
cd ~/projects/my-app
git init

# 创建 .gitignore
cat > .gitignore <<'EOF'
# 数据目录
data/
logs/
*.log

# 环境变量（如包含敏感信息）
.env.local
.env.production
.env.secret

# Docker 数据卷
volumes/

# 临时文件
*.tmp
*.bak
EOF

# 提交
git add docker-compose.yml .gitignore
git commit -m "Initial commit: Docker Compose config for my-app"

# 添加说明
cat > README.md <<'EOF'
# My App Docker Compose

## 快速启动
docker compose up -d

## 查看日志
docker compose logs -f

## 停止服务
docker compose down
EOF

git add README.md
git commit -m "Add README"
```

### 7.4 环境分离

```bash
# 导出基础配置
./docker-export-compose.sh my-app

cd my-app

# 创建开发环境配置
cat > docker-compose.dev.yml <<'EOF'
version: '3.8'

services:
  my-app:
    environment:
      - APP_ENV=development
      - DEBUG=true
    ports:
      - "8080:80"
EOF

# 创建生产环境配置
cat > docker-compose.prod.yml <<'EOF'
version: '3.8'

services:
  my-app:
    environment:
      - APP_ENV=production
      - DEBUG=false
    ports:
      - "80:80"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
EOF

# 使用开发环境
docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# 使用生产环境
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### 7.5 自动化备份脚本

```bash
#!/bin/bash
# backup-all-containers.sh - 定期备份所有容器配置

BACKUP_DIR="/backup/docker-compose-$(date +%Y%m%d_%H%M%S)"

# 导出所有容器
./docker-export-compose.sh --all -o "$BACKUP_DIR"

# 打包
tar -czf "${BACKUP_DIR}.tar.gz" "$BACKUP_DIR"

# 清理解压后的目录
rm -rf "$BACKUP_DIR"

# 只保留最近 30 天的备份
find /backup -name "docker-compose-*.tar.gz" -mtime +30 -delete

echo "备份完成：${BACKUP_DIR}.tar.gz"
```

```bash
# 添加到 crontab（每天凌晨 2 点备份）
crontab -e

# 添加：
0 2 * * * /path/to/backup-all-containers.sh >> /var/log/docker-backup.log 2>&1
```

---

## 📊 命令速查表

### 基础命令

```bash
# 单个容器
./docker-export-compose.sh <容器名>

# 指定输出目录
./docker-export-compose.sh -o <目录> <容器名>

# 从文件批量导出
./docker-export-compose.sh --file <文件>

# 导出所有容器
./docker-export-compose.sh --all

# 导出运行中容器
./docker-export-compose.sh --all-run

# 导出已停止容器
./docker-export-compose.sh --all-stop
```

### 组合使用

```bash
# 批量导出到指定目录
./docker-export-compose.sh --file list.txt -o /backup

# 导出所有运行中容器（安静模式）
./docker-export-compose.sh --all-run --quiet

# 模拟导出所有容器
./docker-export-compose.sh --all --dry-run

# 覆盖模式导出
./docker-export-compose.sh --overwrite <容器名>
```

### 帮助和信息

```bash
# 英文帮助
./docker-export-compose.sh --help

# 中文帮助
./docker-export-compose.sh --help-cn

# 版本信息
./docker-export-compose.sh --version
```

---

## 🔧 高级技巧

### 技巧 1：创建统一的 Compose 项目

```bash
# 导出所有容器
./docker-export-compose.sh --all-run -o /tmp/export

# 合并为一个 docker-compose.yml
cat > docker-compose.yml <<'EOF'
version: '3.8'

services:
EOF

# 将所有容器配置合并
for dir in /tmp/export/*/; do
    # 提取 services 部分（去掉头部）
    sed -n '/^services:/,/^# ════════/p' "$dir/docker-compose.yml" | \
    grep -v '^version:' | grep -v '^services:' | grep -v '^# ════════' >> docker-compose.yml
done

# 验证
docker compose config
```

### 技巧 2：只导出特定镜像的容器

```bash
# 只导出使用 alpine 镜像的容器
docker ps -a --filter ancestor=alpine --format '{{.Names}}' > alpine-containers.txt

./docker-export-compose.sh --file alpine-containers.txt -o /backup/alpine

# 只导出特定标签的容器
docker ps -a --filter label=app=myapp --format '{{.Names}}' > myapp-containers.txt

./docker-export-compose.sh --file myapp-containers.txt
```

### 技巧 3：导出前后对比

```bash
# 导出前记录
docker inspect my-container > before-inspect.json

# 导出
./docker-export-compose.sh my-container

# 使用 Compose 启动
cd my-container
docker compose up -d

# 导出后检查（Compose 容器）
docker inspect my-container > after-inspect.json

# 对比配置
diff before-inspect.json after-inspect.json

# 对比运行状态
docker inspect my-container --format='{{.State.Status}}'
```

---

## 📖 相关文档

- **完整教程**：[12_Docker基础教学_HelloWorld入门指南.md](12_Docker基础教学_HelloWorld入门指南.md)
  - 第 9.8 节：容器命名规则
  - 第 9.14 节：docker run 转 Compose 详解

- **脚本说明**：[docker-scripts-README.md](docker-scripts-README.md)

---

## 🎯 总结

### 核心优势

```
✅ 不影响原容器（只读取配置，不修改容器）
✅ 自动处理目录冲突（递增编号）
✅ 支持单个、批量、全部导出
✅ 中英文帮助
✅ 完整的配置提取
✅ 智能过滤和优化
✅ 安全可靠（支持 dry-run）
```

### 使用流程

```
1. 查看容器
   docker ps -a

2. 导出配置
   ./docker-export-compose.sh <容器名>

3. 验证配置
   docker compose config

4. 测试启动
   docker compose up -d

5. 确认无误后迁移
   docker stop <原容器>
   docker rm <原容器>

6. 正式使用
   docker compose up -d
```

---

**最后更新**：2025-11-06  
**版本**：v1.0  
**许可证**：CC BY-SA 4.0

