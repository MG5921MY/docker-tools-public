# Config 文件使用指南 - 自定义敏感关键词配置

## 📋 文档信息

- **版本**: v1.0
- **创建日期**: 2025-11-06
- **适用于**: docker-export-compose.sh v2.2+
- **文件位置**: `export/sh/config`

---

## 🎯 功能说明

`config` 文件允许您**自定义额外的敏感环境变量关键词**，补充脚本内置的 50+ 个关键词。

### 为什么需要自定义关键词？

虽然脚本内置了 50+ 个常见敏感关键词，但不同的组织和项目可能有特定的命名规范：

```bash
# 公司特定的命名
MYCOMPANY_SECRET_KEY
INTERNAL_API_TOKEN
PRIVATE_DATABASE_URL

# 项目特定的命名
PROJECT_AUTH_TOKEN
CUSTOM_ENCRYPTION_KEY
```

---

## 📝 配置文件说明

### 文件位置

```
export/sh/config
```

### 自动创建

如果 `config` 文件不存在，脚本会在首次运行时自动创建一个包含示例的模板文件。

```bash
# 首次运行脚本
./docker-export-compose.sh my-container

# 输出：
# [INFO] 配置文件不存在，正在创建模板：/path/to/config
# [SUCCESS] 配置文件模板已创建：/path/to/config
# [INFO] 您可以编辑此文件添加自定义敏感关键词
```

---

## 🔧 使用方法

### 步骤 1：查看或编辑 config 文件

```bash
# 进入脚本目录
cd export/sh

# 查看 config 文件
cat config

# 编辑 config 文件
nano config
# 或
vim config
```

### 步骤 2：添加自定义关键词

在 config 文件中添加您的关键词（每行一个）：

```bash
# ═══════════════════════════════════════════════════════════════
# 在下方添加您的自定义关键词 / Add your custom keywords below:

# 公司特定的敏感变量
MYCOMPANY_SECRET
COMPANY_API_KEY
INTERNAL_TOKEN

# 项目特定的敏感变量
PROJECT_AUTH
CUSTOM_ENCRYPTION_KEY
```

### 步骤 3：运行脚本

```bash
# 脚本会自动加载自定义关键词
./docker-export-compose.sh my-container

# 输出示例：
# [INFO] 加载自定义敏感关键词：/path/to/config
# [SUCCESS] 成功加载 3 个自定义关键词
# 自定义关键词列表：
#   - MYCOMPANY_SECRET
#   - COMPANY_API_KEY
#   - INTERNAL_TOKEN
```

---

## 📖 config 文件格式

### 基本格式

```bash
# 1. 每行一个关键词
KEYWORD1
KEYWORD2
KEYWORD3

# 2. 使用 # 开头表示注释（整行）
# 这是注释行，会被忽略

# 3. 空行会被自动忽略

# 4. 使用 ! 开头表示排除（⭐ v2.2.1 新功能）
!EXCLUDED_VAR
!PUBLIC_DATABASE_URL

KEYWORD4  # ⚠️ 注意：行尾注释不支持，会导致格式错误
```

### 排除功能说明 (⭐ v2.2.1 新增)

**功能**: 使用 `!` 前缀标记某些变量为"非敏感"，在 env 模式下直接写入 docker-compose.yml，不使用 .env 文件

#### 排除功能的核心作用

**在 env 模式下**：
- **被排除的变量** → 直接明文写入 docker-compose.yml（不使用 .env）
- **未被排除的变量** → 写入 .env 文件，yml 中使用 `${VAR}` 引用

**在 yml 模式下**：
- 排除功能不影响输出（所有变量都直接在 yml 中）

#### 使用场景

```bash
# 场景 1：公开的配置（不需要保护）
!TZ                      # 时区，公开配置
!PUBLIC_DATABASE_URL     # 公开只读数据库
!API_ENDPOINT_URL        # API 地址，非密钥

# 场景 2：演示/测试数据（非真实敏感数据）
!DEMO_PASSWORD          # 演示密码
!TEST_SECRET_KEY        # 测试密钥
!EXAMPLE_API_TOKEN      # 示例令牌

# 场景 3：简化部署（减少 .env 文件维护）
!APP_NAME               # 应用名称
!APP_VERSION            # 版本号
!LOG_LEVEL              # 日志级别
```

#### 效果对比

**env 模式（无排除）**：
```yaml
# docker-compose.yml
environment:
  - TZ=${TZ}
  - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}

# .env
TZ=Asia/Shanghai
MYSQL_ROOT_PASSWORD=secret123

# .env.example
TZ=Asia/Shanghai
MYSQL_ROOT_PASSWORD=<请填写 / FILL_THIS>
```

**env 模式（使用排除 !TZ）**：
```yaml
# docker-compose.yml
environment:
  # 从 .env 文件加载
  - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
  
  # 排除变量（直接设置）
  - TZ=Asia/Shanghai  # 排除变量 / Excluded

# .env (不包含 TZ)
MYSQL_ROOT_PASSWORD=secret123

# .env.example (不包含 TZ)
MYSQL_ROOT_PASSWORD=<请填写 / FILL_THIS>
```

**优势**：
- ✓ 减少 .env 文件内容（只包含真正敏感的）
- ✓ 公开配置可以直接提交到 Git
- ✓ 简化部署（不需要在 .env 中配置公开变量）
- ✓ 更清晰的配置分离

**匹配方式**: 精确匹配（完整变量名）

```bash
# config 文件
!PUBLIC_DATABASE_URL

# 匹配结果
PUBLIC_DATABASE_URL=xxx      # ✅ 被排除（精确匹配）
PRIVATE_DATABASE_URL=xxx     # ❌ 未被排除（不匹配）
MY_PUBLIC_DATABASE_URL=xxx   # ❌ 未被排除（不匹配）
```

**⚠️ 注意**: 排除规则使用精确匹配，不是部分匹配

### 关键词格式要求

**允许的字符**:
- 大小写字母（A-Z, a-z）
- 数字（0-9）
- 下划线（_）
- 横杠（-）

**示例**:
```bash
# ✅ 有效的关键词
MY_SECRET
API-KEY
Token123
COMPANY_PRIVATE_KEY

# ❌ 无效的关键词（会被跳过）
MY SECRET        # 包含空格
API@KEY          # 包含特殊字符
$TOKEN           # 包含 $
MY_KEY=value     # 包含 =
```

### 大小写处理

关键词匹配是**大小写不敏感**的：

```bash
# config 文件中
MYCOMPANY_SECRET

# 会匹配以下所有变量：
MYCOMPANY_SECRET=xxx
mycompany_secret=xxx
MyCompany_Secret=xxx
```

---

## 💡 使用示例

### 示例 1：使用排除功能 (⭐ v2.2.1 新增)

```bash
# 场景：容器有一些包含敏感关键词但实际不敏感的变量

# 步骤 1：查看原始容器的环境变量
docker inspect my-app --format='{{range .Config.Env}}{{.}}{{"\n"}}{{end}}'

# 输出：
# PUBLIC_DATABASE_URL=postgres://public_db:5432/readonly
# DEMO_PASSWORD=demo123
# API_ENDPOINT_URL=https://api.example.com
# REAL_API_SECRET=sk-abc123xyz  # 这个才是真正敏感的

# 步骤 2：编辑 config 文件
cat > export/sh/config <<'EOF'
# 排除非敏感变量（虽然包含敏感关键词）
!PUBLIC_DATABASE_URL   # 公开的只读数据库
!DEMO_PASSWORD         # 演示密码，非敏感
!API_ENDPOINT_URL      # 只是 API 地址，不是密钥
EOF

# 步骤 3：运行脚本
./docker-export-compose.sh --type env my-app

# 输出日志：
# [SUCCESS] 成功加载 3 个排除关键词
# 排除关键词（不视为敏感）：
#   - PUBLIC_DATABASE_URL
#   - DEMO_PASSWORD
#   - API_ENDPOINT_URL

# 步骤 4：查看生成的文件
cat output/my-app/docker-compose.yml

# docker-compose.yml 中的环境变量部分：
# environment:
#   # 从 .env 文件加载
#   - REAL_API_SECRET=${REAL_API_SECRET}
#   
#   # 排除变量（直接设置，不使用 .env）
#   - PUBLIC_DATABASE_URL=postgres://public_db:5432/readonly  # 排除变量
#   - DEMO_PASSWORD=demo123  # 排除变量
#   - API_ENDPOINT_URL=https://api.example.com  # 排除变量

cat output/my-app/.env

# .env 文件（只包含未被排除的敏感变量）：
# REAL_API_SECRET=sk-abc123xyz

cat output/my-app/.env.example

# .env.example 文件（只包含未被排除的变量）：
# REAL_API_SECRET=<请填写 / FILL_THIS>
```

**效果对比**:

| 变量名 | 无排除规则 | 有排除规则（!标记）|
|--------|-----------|-------------------|
| PUBLIC_DATABASE_URL | .env 中：xxx<br>yml 中：${VAR} | ✅ yml 中：明文<br>不在 .env 中 |
| DEMO_PASSWORD | .env 中：xxx<br>yml 中：${VAR} | ✅ yml 中：明文<br>不在 .env 中 |
| API_ENDPOINT_URL | .env 中：xxx<br>yml 中：${VAR} | ✅ yml 中：明文<br>不在 .env 中 |
| REAL_API_SECRET | .env 中：xxx<br>yml 中：${VAR} | .env 中：xxx<br>yml 中：${VAR} |

**核心区别**：
- ❌ 不是"保留值 vs 隐藏值"的区别
- ✅ 是"在 .env 中 vs 在 yml 中"的区别

---

### 示例 2：公司标准敏感变量

```bash
# config 文件
# ═══════════════════════════════════════
# 公司标准敏感环境变量
# ═══════════════════════════════════════

# 内部 API
INTERNAL_API_KEY
INTERNAL_API_SECRET

# 公司密钥
ACME_CORP_SECRET
ACME_CORP_TOKEN

# 私有服务
PRIVATE_SERVICE_KEY
```

**效果**:
```yaml
# 生成的 docker-compose.yml（yml 模式）
environment:
  - INTERNAL_API_KEY=xxx  # ⚠️ 敏感信息 / SENSITIVE
  - ACME_CORP_SECRET=xxx  # ⚠️ 敏感信息 / SENSITIVE
```

---

### 示例 2：项目特定变量

```bash
# config 文件
# ═══════════════════════════════════════
# 项目特定敏感变量
# ═══════════════════════════════════════

# 游戏项目密钥
GAME_SERVER_KEY
PLAYER_AUTH_TOKEN
PAYMENT_SECRET

# 数据库相关
CUSTOM_DB_CONNECTION
```

**效果**:
```bash
# env 模式下的 .env.example
GAME_SERVER_KEY=<请填写 / FILL_THIS>
PLAYER_AUTH_TOKEN=<请填写 / FILL_THIS>
PAYMENT_SECRET=<请填写 / FILL_THIS>
CUSTOM_DB_CONNECTION=<请填写 / FILL_THIS>
```

---

### 示例 3：组合使用（添加 + 排除）⭐

```bash
# config 文件
# ═══════════════════════════════════════
# 综合配置示例
# ═══════════════════════════════════════

# ─────────────────────────────────────
# 添加：公司特定的敏感变量
# ─────────────────────────────────────
ACME_CORP_SECRET
ACME_API_KEY
INTERNAL_SERVICE_TOKEN

# ─────────────────────────────────────
# 排除：虽然包含敏感词但实际非敏感的变量
# ─────────────────────────────────────
!PUBLIC_API_ENDPOINT    # API 地址，非密钥
!DEMO_PASSWORD          # 演示密码
!TEST_DATABASE_URL      # 测试数据库（公开）
!READONLY_SECRET_PATH   # 只是路径，不是密钥

# ─────────────────────────────────────
# 效果说明
# ─────────────────────────────────────
# ACME_CORP_SECRET=xxx        → ⚠️ 敏感（自定义添加）
# PUBLIC_API_ENDPOINT=xxx     → ✅ 正常（明确排除）
# DEMO_PASSWORD=demo123       → ✅ 正常（明确排除）
# REAL_PASSWORD=secret        → ⚠️ 敏感（内置关键词）
```

---

### 示例 4：临时测试关键词

```bash
# config 文件
# ═══════════════════════════════════════
# 临时测试
# ═══════════════════════════════════════

# 测试用敏感变量
TEST_SENSITIVE_VAR
DEBUG_SECRET_KEY

# 取消注释以禁用（推荐使用排除功能）：
# 旧方法：注释掉
# TEST_SENSITIVE_VAR
# DEBUG_SECRET_KEY

# 新方法：使用排除（更明确）⭐
# !TEST_SENSITIVE_VAR
# !DEBUG_SECRET_KEY
```

---

## ⚠️ 注意事项

### 1. 不要添加过于宽泛的关键词

```bash
# ❌ 不推荐：过于宽泛
DATA
VALUE
CONFIG

# 这些关键词会导致误判，将很多普通变量标记为敏感

# ✅ 推荐：具体的关键词
SENSITIVE_DATA
SECRET_VALUE
PRIVATE_CONFIG
```

### 2. config 文件本身的安全

```bash
# config 文件通常不包含敏感信息（只是关键词）
# 但如果您的关键词本身敏感，建议：

# 方法 1：添加到 .gitignore
echo "export/sh/config" >> .gitignore

# 方法 2：使用示例文件
cp config config.example  # 提交 config.example
# config 文件本身不提交
```

### 3. 验证关键词效果

```bash
# 运行脚本时会显示加载的关键词
./docker-export-compose.sh my-container

# 输出：
# [INFO] 加载自定义敏感关键词：/path/to/config
# [SUCCESS] 成功加载 3 个自定义关键词
# 自定义关键词列表：
#   - MYCOMPANY_SECRET
#   - COMPANY_API_KEY
#   - INTERNAL_TOKEN

# 检查生成的配置文件
cat output/my-container/docker-compose.yml
# 或
cat output/my-container/.env.example
```

---

## 🐛 故障排查

### 问题 1：关键词未生效

**症状**:
```bash
# 添加了 MYCOMPANY_SECRET 到 config
# 但生成的配置中未标记为敏感
```

**检查步骤**:
```bash
# 1. 确认 config 文件位置正确
ls -la export/sh/config

# 2. 检查关键词格式
cat export/sh/config | grep MYCOMPANY

# 3. 确认没有拼写错误（大小写不敏感，但拼写要正确）

# 4. 重新运行脚本并查看日志
./docker-export-compose.sh my-container
```

---

### 问题 2：配置文件读取失败

**症状**:
```bash
[ERROR] 读取配置文件失败：/path/to/config
```

**原因和解决**:
```bash
# 原因 1：文件权限问题
chmod 644 config

# 原因 2：文件格式错误（如包含特殊字符）
# 检查文件编码
file config
# 应该是：UTF-8 Unicode text

# 原因 3：文件损坏
# 删除并重新创建
rm config
./docker-export-compose.sh my-container
```

---

### 问题 3：部分关键词被跳过

**症状**:
```bash
[WARN] 配置文件第 5 行格式无效，已跳过：MY@SECRET
[WARN] 跳过了 1 个无效行
```

**原因和解决**:
```bash
# 关键词包含不允许的字符
# 只允许：A-Z, a-z, 0-9, _, -

# 修改 config 文件，移除特殊字符
# 错误：MY@SECRET
# 正确：MY_SECRET
```

---

## 📚 完整示例

### 实际使用案例

```bash
# 场景：某公司的 Docker 容器使用特定的命名规范

# 步骤 1：创建/编辑 config 文件
cat > export/sh/config <<'EOF'
# ═══════════════════════════════════════
# ACME 公司敏感变量规范
# ═══════════════════════════════════════

# 内部 API
ACME_API_KEY
ACME_API_SECRET
ACME_INTERNAL_TOKEN

# 数据库
ACME_DB_PASSWORD
ACME_DB_CONNECTION

# 服务密钥
ACME_SERVICE_KEY
ACME_WEBHOOK_SECRET

# 加密相关
ACME_ENCRYPTION_KEY
ACME_SIGNING_KEY

# 第三方集成
PARTNER_API_KEY
PARTNER_SECRET
EOF

# 步骤 2：运行脚本
./docker-export-compose.sh --type env --privacy acme-web-app

# 步骤 3：验证效果
cat output/acme-web-app/.env.example

# 输出示例：
# ACME_API_KEY=<请填写 / FILL_THIS>          # 被标记为敏感
# ACME_API_SECRET=<请填写 / FILL_THIS>       # 被标记为敏感
# ACME_INTERNAL_TOKEN=<请填写 / FILL_THIS>   # 被标记为敏感
# APP_NAME=acme-web                           # 非敏感，保留原值
# APP_VERSION=1.0.0                           # 非敏感，保留原值
```

---

## 🔍 内置关键词列表

以下关键词已内置，**无需**添加到 config 文件：

### 密码相关
```
PASSWORD, PASSWD, PWD, PASS
```

### 密钥和令牌
```
SECRET, TOKEN, KEY, APIKEY
API_KEY, API_SECRET, API_TOKEN
ACCESS_KEY, ACCESS_TOKEN, ACCESS_SECRET
PRIVATE_KEY, PUBLIC_KEY, SSH_KEY
```

### 认证相关
```
AUTH, AUTHENTICATION, AUTHORIZATION
CREDENTIALS, CREDENTIAL
SESSION, SESSION_KEY, SESSION_SECRET
OAUTH, OAUTH_TOKEN, OAUTH_SECRET
```

### 证书相关
```
CERT, CERTIFICATE, SSL, TLS
PRIVATE, PEM, P12, PKCS
```

### 加密相关
```
SALT, HASH, ENCRYPTION, DECRYPT
CIPHER, AES, RSA
```

### 数据库连接
```
DATABASE_URL, DB_PASSWORD, DB_USER
CONNECTION_STRING, CONN_STR
MYSQL_PASSWORD, POSTGRES_PASSWORD
MONGO_PASSWORD, REDIS_PASSWORD
```

### 管理员相关
```
ADMIN, ROOT, SUPERUSER
ADMIN_PASSWORD, ROOT_PASSWORD
```

### 云服务密钥
```
AWS_SECRET, AWS_ACCESS, AWS_KEY
AZURE_, GCP_, GOOGLE_, CLOUD_, S3_
```

### 其他
```
SIGNING_KEY, JWT_SECRET, JWT_KEY
WEBHOOK_SECRET, ENCRYPTION_KEY
```

**只需添加您组织/项目特有的关键词即可！**

---

## 💡 最佳实践

### 1. 保持关键词列表精简

```bash
# ✅ 好的做法
# 只添加真正需要的特定关键词
COMPANY_SECRET
PROJECT_TOKEN

# ❌ 不好的做法
# 添加过多或过于宽泛的关键词
DATA
VALUE
INFO
CONFIG
```

### 2. 使用清晰的注释

```bash
# ✅ 好的做法
# ═══════════════════════════════════════
# 公司 API 密钥相关
# ═══════════════════════════════════════
COMPANY_API_KEY
COMPANY_API_SECRET

# ═══════════════════════════════════════
# 第三方服务集成
# ═══════════════════════════════════════
PARTNER_SERVICE_TOKEN
VENDOR_API_KEY
```

### 3. 定期审查和更新

```bash
# 每季度审查 config 文件
# 1. 移除不再使用的关键词
# 2. 添加新的敏感变量命名规范
# 3. 更新注释说明
```

### 4. 团队共享（可选）

```bash
# 如果团队使用统一的命名规范：

# 创建示例文件
cp config config.example

# 提交到 Git
git add export/sh/config.example
git commit -m "Add custom sensitive keywords template"

# 团队成员使用
cp config.example config
# 按需调整
```

---

## 🔄 config 文件模板

### 完整的模板示例

```bash
# ═══════════════════════════════════════════════════════════════
# Docker Export Compose - 自定义敏感关键词配置文件
# ═══════════════════════════════════════════════════════════════
# 版本: v2.2
# 创建: 2025-11-06
# 说明: 此文件用于自定义额外的敏感环境变量关键词
# ═══════════════════════════════════════════════════════════════

# 使用说明 / Usage:
# 1. 每行一个关键词（大小写不敏感）
# 2. 使用 # 开头表示注释
# 3. 空行会被忽略
# 4. 脚本会自动检测包含这些关键词的环境变量

# ═══════════════════════════════════════════════════════════════
# 内置关键词（无需添加，已自动包含）/ Built-in Keywords:
# ═══════════════════════════════════════════════════════════════
# PASSWORD, PASSWD, PWD, PASS
# SECRET, TOKEN, KEY, APIKEY
# ... (省略 50+ 个内置关键词)
# ═══════════════════════════════════════════════════════════════

# 在下方添加您的自定义关键词 / Add your custom keywords below:

# ═══════════════════════════════════════
# 公司特定变量
# ═══════════════════════════════════════
# COMPANY_SECRET
# INTERNAL_API_KEY

# ═══════════════════════════════════════
# 项目特定变量
# ═══════════════════════════════════════
# PROJECT_AUTH_TOKEN
# CUSTOM_ENCRYPTION_KEY

# ═══════════════════════════════════════
# 第三方服务
# ═══════════════════════════════════════
# PARTNER_TOKEN
# VENDOR_API_KEY
```

---

## 📊 效果对比

### 没有自定义关键词

```yaml
# 生成的配置（yml 模式）
environment:
  - APP_NAME=myapp
  - MYCOMPANY_SECRET=xxx123  # 未被识别为敏感
  - DEBUG=true
```

### 添加自定义关键词后

```bash
# config 文件
MYCOMPANY_SECRET
```

```yaml
# 生成的配置（yml 模式）
# ⚠️ 警告 / WARNING: 以下环境变量可能包含敏感信息
environment:
  - APP_NAME=myapp
  - MYCOMPANY_SECRET=xxx123  # ⚠️ 敏感信息 / SENSITIVE
  - DEBUG=true
```

```bash
# env 模式的 .env.example
APP_NAME=myapp
MYCOMPANY_SECRET=<请填写 / FILL_THIS>  # 自动隐藏
DEBUG=true
```

---

## 🚨 常见错误

### 错误 1：行尾注释

```bash
# ❌ 错误写法
MYCOMPANY_SECRET  # 这是我们的密钥

# 脚本会将整行（包括注释）作为关键词，导致格式错误

# ✅ 正确写法
# 这是我们的密钥
MYCOMPANY_SECRET
```

### 错误 2：包含特殊字符

```bash
# ❌ 错误写法
MY_SECRET!
API@KEY
$TOKEN

# ✅ 正确写法
MY_SECRET
API_KEY
TOKEN
```

### 错误 3：添加内置关键词

```bash
# ❌ 不必要
PASSWORD
SECRET
TOKEN

# 这些关键词已内置，无需添加到 config

# ✅ 只添加特定的
MYCOMPANY_PASSWORD
CUSTOM_SECRET
PROJECT_TOKEN
```

---

## 🔧 高级用法

### 1. 环境特定的 config

```bash
# 为不同环境使用不同的 config

# 开发环境
./docker-export-compose.sh --type env my-dev-app
# 使用：export/sh/config

# 生产环境（使用不同的 config）
CONFIG_FILE=./config.prod ./docker-export-compose.sh --type env my-prod-app
# 注意：目前不支持此用法，config 路径是固定的
```

### 2. 版本控制

```bash
# 创建 config 的版本历史

# config.v1 - 初始版本
cp config config.v1

# config.v2 - 添加新规范
# 编辑 config 添加新关键词
cp config config.v2

# 可以随时回滚
cp config.v1 config
```

---

## 🔍 技术说明

### 为什么使用 "!" 作为排除标记？

**原因分析**:

1. **环境变量命名规范**
   ```bash
   # Docker/Bash 环境变量名只允许：
   # - 字母（A-Z, a-z）
   # - 数字（0-9）
   # - 下划线（_）
   
   # 不允许的字符包括：
   # ! @ # $ % ^ & * ( ) - + = { } [ ] | \ : ; " ' < > , . ? /
   ```

2. **"!" 的安全性**
   - ✅ 不会出现在环境变量名中
   - ✅ 在 Shell 中有明确含义（逻辑非）
   - ✅ 易于识别和理解
   - ✅ 不会与其他语法冲突

3. **替代方案对比**
   
   | 标记 | 安全性 | 语义 | 评价 |
   |------|--------|------|------|
   | `!` | ✅ 安全 | 逻辑非、排除 | ✅ 最佳选择 |
   | `-` | ❌ 可能在变量名中 | 减号 | ❌ 不安全 |
   | `~` | ✅ 安全 | 取反 | ✅ 可选 |
   | `^` | ❌ 某些 shell 中特殊 | 异或 | ⚠️ 可能冲突 |
   | `EXCLUDE:` | ✅ 安全 | 语义明确 | ⚠️ 冗长 |

**结论**: 使用 `!` 作为排除标记是最佳选择 ✅

### 匹配逻辑说明

```
检测流程（is_sensitive_env 函数）：

1. 检查排除列表（精确匹配）
   ├─ 如果变量名在排除列表 → 返回"不敏感"（结束）
   └─ 如果不在排除列表 → 继续

2. 检查内置关键词（部分匹配）
   ├─ 如果包含任何内置关键词 → 返回"敏感"（结束）
   └─ 如果不包含 → 继续

3. 检查自定义关键词（部分匹配）
   ├─ 如果包含任何自定义关键词 → 返回"敏感"（结束）
   └─ 如果不包含 → 返回"不敏感"

优先级：排除 > 内置 > 自定义
```

**示例**:
```bash
# config 文件
COMPANY_SECRET      # 添加
!PUBLIC_PASSWORD    # 排除

# 变量检测
MY_COMPANY_SECRET=xxx    # 匹配 COMPANY_SECRET → 敏感
PUBLIC_PASSWORD=xxx      # 精确匹配排除列表 → 不敏感（即使包含 PASSWORD）
PRIVATE_PASSWORD=xxx     # 包含 PASSWORD → 敏感（不在排除列表）
```

---

## 📖 相关文档

- [脚本使用说明](../README.md) - 完整功能介绍
- [安全使用指南](1_安全使用指南.md) - 安全最佳实践
- [快速参考](3_快速参考.md) - 命令速查
- [更新日志](5_更新日志.md) - 版本历史和最新功能
- [文档索引](0_README.md) - 返回文档中心

---

## 💬 常见问题

**Q: config 文件是必需的吗？**  
A: 不是。如果不存在，脚本会自动创建模板，使用内置的 50+ 关键词已足够大多数情况。

**Q: 可以使用中文关键词吗？**  
A: 理论上可以，但不推荐。Docker 环境变量通常使用英文命名。

**Q: 修改 config 后需要重启什么吗？**  
A: 不需要。每次运行脚本时都会重新读取 config 文件。

**Q: config 文件会被提交到 Git 吗？**  
A: 默认不会被 .gitignore 忽略（因为它只包含关键词，不是敏感数据）。如果您认为关键词本身敏感，可以手动添加到 .gitignore。

**Q: 可以临时禁用自定义关键词吗？**  
A: 可以。将 config 文件重命名（如 config.bak）或清空文件内容。

**Q: 排除功能 (!) 和注释 (#) 有什么区别？** ⭐  
A: 
- `#` 注释：整行被忽略，不处理
- `!` 排除：明确标记某变量为"非敏感"，即使它包含敏感关键词
- 使用排除更明确，推荐用于需要明确排除的变量

**Q: 排除功能使用精确匹配还是部分匹配？** ⭐  
A: **精确匹配**。例如 `!PUBLIC_PASSWORD` 只会排除完全匹配 `PUBLIC_PASSWORD` 的变量，不会影响 `MY_PUBLIC_PASSWORD`。

**Q: 可以排除内置关键词吗？** ⭐  
A: 可以！排除列表的优先级最高，即使是内置关键词（如 PASSWORD、SECRET）也可以通过 `!变量名` 排除特定的变量。

**Q: 为什么选择 "!" 而不是其他符号？**  
A: 因为 Docker 环境变量名不允许包含 "!" 字符（只允许字母、数字、下划线），所以使用 "!" 作为标记是完全安全的。详见"技术说明"章节。

---

**文档版本**: v1.0  
**最后更新**: 2025-11-06  
**维护者**: clearlove.ymg  
**许可证**: MIT License

---

**提示**: 合理使用自定义关键词可以更好地保护组织特定的敏感信息！🔐



---

# 以下内容来自: EXCLUDE_FEATURE_TEST.md

# 排除功能测试指南 - ! 标记使用说明

## 🎯 功能说明

**排除功能**：使用 `!` 前缀标记的变量会被排除，在 env 模式下：
- ✅ **直接写入** docker-compose.yml（明文）
- ❌ **不写入** .env 文件
- ❌ **不写入** .env.example 文件

**核心理念**：被排除的变量 = 非敏感 = 可以明文提交到 Git

---

## 🧪 测试步骤

### 测试场景：MySQL 容器

假设您有一个 MySQL 容器，包含以下环境变量：
- `TZ=Asia/Shanghai` - 时区（公开配置）
- `MYSQL_ROOT_PASSWORD=secret123` - 真正的敏感数据
- `MYSQL_DATABASE=myapp` - 数据库名（非敏感）

---

### 步骤 1：创建测试 config 文件

```bash
cd /mijiao/pak/shell/docker/docker-to-compose

# 创建 config 文件
cat > config <<'EOF'
# 测试排除功能

# 排除 TZ（时区是公开配置）
!TZ

# 如果您想测试排除敏感变量（仅用于演示）
# !MYSQL_ROOT_PASSWORD
EOF
```

---

### 步骤 2：运行导出

```bash
./docker-export-compose.sh --type env mysql
```

**预期输出**：
```
[INFO] 加载自定义敏感关键词配置：/mijiao/pak/shell/docker/docker-to-compose/config
[SUCCESS] 成功加载 1 个排除关键词
[INFO] 排除关键词（不视为敏感）：
  - TZ
```

---

### 步骤 3：验证生成的文件

#### A. 检查 docker-compose.yml

```bash
cat ./output/mysql/docker-compose.yml
```

**应该包含（重点关注 environment 部分）**：
```yaml
environment:
  # ─────────────────────────────────────────────
  # 从 .env 文件加载 / Loaded from .env file
  # ─────────────────────────────────────────────
  - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
  - MYSQL_DATABASE=${MYSQL_DATABASE}
  
  # ─────────────────────────────────────────────
  # 排除变量（直接设置，不使用 .env）/ Excluded (Direct)
  # 说明：这些变量被 config 文件标记为非敏感
  # ─────────────────────────────────────────────
  - TZ=Asia/Shanghai  # 排除变量 / Excluded
```

**✅ 正确**: TZ 直接明文显示在 yml 中  
**❌ 错误**: 如果 TZ 显示为 `TZ=${TZ}`，说明排除未生效

---

#### B. 检查 .env 文件

```bash
cat ./output/mysql/.env
```

**应该包含**：
```bash
# 只包含未被排除的变量
MYSQL_ROOT_PASSWORD=secret123
MYSQL_DATABASE=myapp
```

**✅ 正确**: 不包含 TZ  
**❌ 错误**: 如果包含 `TZ=Asia/Shanghai`，说明排除未生效

---

#### C. 检查 .env.example 文件

```bash
cat ./output/mysql/.env.example
```

**应该包含**：
```bash
# 只包含未被排除的变量
MYSQL_ROOT_PASSWORD=<请填写 / FILL_THIS>
MYSQL_DATABASE=myapp
```

**✅ 正确**: 不包含 TZ  
**❌ 错误**: 如果包含 `TZ=...`，说明排除未生效

---

### 步骤 4：功能验证

#### 测试 1：基本排除

```bash
# config 文件
!TZ

# 预期结果
✅ yml: TZ=Asia/Shanghai（明文）
✅ .env: 不包含 TZ
✅ .env.example: 不包含 TZ
```

#### 测试 2：排除敏感关键词

```bash
# config 文件
!TZ
!MYSQL_ROOT_PASSWORD  # 排除真正敏感的变量

# 预期结果
✅ yml: TZ=Asia/Shanghai（明文）
✅ yml: MYSQL_ROOT_PASSWORD=secret123（明文）
✅ .env: 只包含 MYSQL_DATABASE
✅ .env.example: 只包含 MYSQL_DATABASE
```

#### 测试 3：大小写不敏感

```bash
# config 文件（小写）
!tz
!mysql_root_password

# 预期结果（应该能匹配 TZ 和 MYSQL_ROOT_PASSWORD）
✅ yml: TZ=Asia/Shanghai（明文）
✅ yml: MYSQL_ROOT_PASSWORD=secret123（明文）
```

---

## 🔧 如果功能未生效

### 调试步骤

#### 1. 检查 config 文件格式

```bash
# 查看 config 文件
cat config

# 确保格式正确
!TZ                    # ✅ 正确
! TZ                   # ❌ 有多余空格
!TZ  # 注释            # ⚠️ 行尾注释可能导致问题
```

#### 2. 检查变量名是否完全匹配

```bash
# 查看容器的实际环境变量名
docker inspect mysql --format='{{range .Config.Env}}{{.}}{{"\n"}}{{end}}'

# 确认变量名大小写
# 如果是 tz=Asia/Shanghai，在 config 中应该写 !tz 或 !TZ
# 如果是 TZ=Asia/Shanghai，在 config 中应该写 !TZ 或 !tz
```

#### 3. 检查代码版本

```bash
# 确认脚本版本
./docker-export-compose.sh --version

# 应该显示：Version: 2.2 或更高
# 并且包含排除功能的说明
```

#### 4. 启用详细日志

```bash
# 不使用 --quiet 模式
./docker-export-compose.sh --type env mysql

# 查看加载日志
# 应该显示：
# [SUCCESS] 成功加载 X 个排除关键词
# [INFO] 排除关键词（不视为敏感）：
#   - TZ
#   - ...
```

---

## 📊 完整测试案例

### 测试案例 1：TZ 排除

```bash
# 1. 创建 config
echo "!TZ" > config

# 2. 运行导出
./docker-export-compose.sh --type env mysql

# 3. 验证 yml
grep -A5 "environment:" ./output/mysql/docker-compose.yml
# 应该看到 TZ=Asia/Shanghai（明文）

# 4. 验证 .env
grep "TZ" ./output/mysql/.env
# 应该没有输出（TZ 不在 .env 中）

# 5. 验证 .env.example  
grep "TZ" ./output/mysql/.env.example
# 应该没有输出（TZ 不在 .env.example 中）
```

---

### 测试案例 2：同时排除多个变量

```bash
# 1. 创建 config
cat > config <<'EOF'
# 排除公开配置
!TZ
!MYSQL_DATABASE
EOF

# 2. 运行导出
./docker-export-compose.sh --type env mysql

# 3. 验证结果
# yml 中应该有：
#   - TZ=Asia/Shanghai
#   - MYSQL_DATABASE=myapp
# .env 中应该只有：
#   - MYSQL_ROOT_PASSWORD=xxx
```

---

### 测试案例 3：排除内置敏感关键词

```bash
# 1. 创建 config（排除真正的密码）
cat > config <<'EOF'
# 演示：排除密码（仅用于测试）
!MYSQL_ROOT_PASSWORD
EOF

# 2. 运行导出
./docker-export-compose.sh --type env mysql

# 3. 验证结果
# yml 中应该有：
#   - MYSQL_ROOT_PASSWORD=secret123（明文）
# .env 和 .env.example 不应包含 MYSQL_ROOT_PASSWORD
```

---

## ⚠️ 重要说明

### 排除功能的适用场景

**✅ 推荐排除的变量**:
```bash
!TZ                    # 时区
!APP_NAME              # 应用名称
!APP_VERSION           # 版本号
!LOG_LEVEL             # 日志级别
!PUBLIC_DATABASE_URL   # 公开只读数据库
!API_ENDPOINT_URL      # API 地址（非密钥）
```

**❌ 不应排除的变量**:
```bash
# 真正的密码和密钥不应排除
# 即使是演示环境，也建议使用 .env 管理
MYSQL_ROOT_PASSWORD    # 不要排除
API_SECRET_KEY         # 不要排除
JWT_SECRET             # 不要排除
```

### 安全建议

```
排除功能的目的：
✓ 将非敏感的公开配置直接写在 yml 中
✓ 减少 .env 文件维护负担
✓ 提高配置可读性

不是用来：
✗ 暴露真正的敏感信息
✗ 绕过安全机制
```

---

## 🐛 已知问题和解决

### 问题 1：排除未生效（变量仍在 .env 中）

**可能原因**:
1. config 文件格式错误
2. 变量名大小写不匹配（虽然应该不敏感）
3. config 文件路径不对
4. 代码版本过旧

**解决方案**:
```bash
# 1. 检查 config 文件
cat config
# 确保是 !VAR_NAME 格式，没有多余空格

# 2. 检查变量名
docker inspect mysql --format='{{range .Config.Env}}{{.}}{{"\n"}}{{end}}' | grep TZ
# 确认实际的变量名

# 3. 检查脚本版本
./docker-export-compose.sh --version
# 确保是 v2.2.1 或更高
```

---

## 📝 完整示例

### 实际使用案例

```bash
# 场景：MySQL 容器有多个环境变量，需要区分处理

# 步骤 1：查看所有环境变量
docker inspect mysql --format='{{range .Config.Env}}{{.}}{{"\n"}}{{end}}'

# 输出示例：
# TZ=Asia/Shanghai
# MYSQL_ROOT_PASSWORD=real_secret_password
# MYSQL_DATABASE=production_db
# MYSQL_USER=appuser
# MYSQL_PASSWORD=user_password

# 步骤 2：创建 config（排除非敏感的）
cat > config <<'EOF'
# 排除公开配置
!TZ                # 时区，公开
!MYSQL_DATABASE    # 数据库名，非敏感
!MYSQL_USER        # 用户名，非敏感

# 不排除真正敏感的：
# MYSQL_ROOT_PASSWORD  - 保持在 .env 中
# MYSQL_PASSWORD       - 保持在 .env 中
EOF

# 步骤 3：导出
./docker-export-compose.sh --type env mysql

# 步骤 4：验证结果
echo "=== docker-compose.yml ==="
grep -A20 "environment:" ./output/mysql/docker-compose.yml

echo ""
echo "=== .env ==="
cat ./output/mysql/.env

echo ""
echo "=== .env.example ==="
cat ./output/mysql/.env.example
```

**预期结果**:

```yaml
# docker-compose.yml
environment:
  # 从 .env 文件加载
  - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
  - MYSQL_PASSWORD=${MYSQL_PASSWORD}
  
  # 排除变量（直接设置）
  - TZ=Asia/Shanghai  # 排除变量
  - MYSQL_DATABASE=production_db  # 排除变量
  - MYSQL_USER=appuser  # 排除变量
```

```bash
# .env（只包含敏感变量）
MYSQL_ROOT_PASSWORD=real_secret_password
MYSQL_PASSWORD=user_password

# .env.example（只包含敏感变量）
MYSQL_ROOT_PASSWORD=<请填写 / FILL_THIS>
MYSQL_PASSWORD=<请填写 / FILL_THIS>
```

---

## ✅ 验证清单

使用此清单验证排除功能是否正确：

- [ ] config 文件已创建，包含 !TZ
- [ ] 运行脚本时显示"成功加载 X 个排除关键词"
- [ ] docker-compose.yml 中 TZ 是明文（不是 ${TZ}）
- [ ] .env 文件中**不包含** TZ
- [ ] .env.example 文件中**不包含** TZ
- [ ] 其他未排除的敏感变量仍在 .env 中使用 ${VAR} 引用

---

## 🆘 故障排查

### 如果排除功能不生效

请依次检查：

```bash
# 1. 检查 config 文件内容
cat config
# 应该看到 !TZ 或 !MYSQL_ROOT_PASSWORD

# 2. 检查加载日志
./docker-export-compose.sh --type env mysql 2>&1 | grep -A5 "排除关键词"
# 应该显示加载的排除关键词

# 3. 检查 docker-compose.yml
grep "TZ" ./output/mysql*/docker-compose.yml
# 应该看到 "- TZ=Asia/Shanghai  # 排除变量"
# 而不是 "- TZ=${TZ}"

# 4. 检查 .env
grep "TZ" ./output/mysql*/.env
# 应该没有输出（TZ 不在 .env 中）

# 5. 如果仍然不生效，查看完整的环境变量部分
grep -A50 "environment:" ./output/mysql*/docker-compose.yml
```

---

## 💡 使用建议

### 推荐排除的变量类型

```bash
# ✅ 公开配置
!TZ
!LANG
!LC_ALL

# ✅ 应用元数据
!APP_NAME
!APP_VERSION
!APP_ENV

# ✅ 非敏感的功能开关
!DEBUG
!LOG_LEVEL
!ENABLE_CACHE

# ✅ 公开的 URL（不含密钥）
!API_BASE_URL
!PUBLIC_ENDPOINT
!SERVICE_URL

# ✅ 数据库/服务名（非密码）
!DATABASE_NAME
!REDIS_DB
!QUEUE_NAME
```

### 不推荐排除的变量

```bash
# ❌ 真正的密码
MYSQL_ROOT_PASSWORD
MYSQL_PASSWORD
POSTGRES_PASSWORD

# ❌ API 密钥/令牌
API_KEY
API_SECRET
API_TOKEN

# ❌ 加密密钥
ENCRYPTION_KEY
JWT_SECRET
SESSION_SECRET

# ❌ 云服务密钥
AWS_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY
```

---

## 📞 获取帮助

如果排除功能仍然不工作，请提供以下信息：

1. **config 文件内容**
   ```bash
   cat config
   ```

2. **脚本版本**
   ```bash
   ./docker-export-compose.sh --version
   ```

3. **运行日志**
   ```bash
   ./docker-export-compose.sh --type env mysql 2>&1 | grep -E "(排除|Excluded|加载|Loaded)"
   ```

4. **生成的文件片段**
   ```bash
   grep -A10 "environment:" ./output/mysql*/docker-compose.yml
   cat ./output/mysql*/.env
   ```

---

**文档版本**: v1.0  
**创建时间**: 2025-11-06  
**适用于**: docker-export-compose.sh v2.2.1+  
**维护者**: clearlove.ymg

